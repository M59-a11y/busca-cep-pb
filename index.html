<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="icon" href="img/favicon.ico" type="image/x-icon">
<link rel="icon" href="img/favicon.png" type="image/png">
<meta charset="UTF-8">
<title>Busca por CEP - PB</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%}
:root{
  --bg1:#0ea5e9;
  --bg2:#22c55e;
  --card:#ffffffee;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e2e8f0;
  --shadow:0 16px 45px rgba(0,0,0,.20);
  --radius:18px;
}
body{
  font-family: Arial, Helvetica, sans-serif;
  background: radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.25), transparent 60%),
              linear-gradient(135deg, var(--bg2), var(--bg1));
  display:flex;
  justify-content:center;
  align-items:center;
  padding:18px;
  color:var(--text);
}

/* container */
.form-container{
  width: 860px;
  max-width: 98vw;
  border-radius: var(--radius);
  background: var(--card);
  box-shadow: var(--shadow);
  overflow:hidden;
  border:1px solid rgba(255,255,255,.35);
}

/* header */
.header{
  padding:18px 18px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.4));
  border-bottom:1px solid rgba(15,23,42,.06);
}
.header h2{
  margin:0;
  font-size:20px;
  letter-spacing:.6px;
  font-weight:900;
}
.badge{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  font-weight:700;
  color:var(--muted);
}
.dot{
  width:10px;height:10px;border-radius:999px;
  background: #22c55e;
  box-shadow:0 0 0 4px rgba(34,197,94,.18);
}

/* body layout */
.body{
  display:grid;
  grid-template-columns: 320px 1fr;
  gap:0;
  min-height: 520px;
}

/* left panel */
.sidebar{
  padding:16px;
  border-right:1px solid rgba(15,23,42,.08);
  background: rgba(255,255,255,.35);
}
.tabs{
  display:flex;
  gap:8px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:6px;
}
.tab{
  flex:1;
  padding:10px 10px;
  text-align:center;
  cursor:pointer;
  border-radius:12px;
  font-weight:800;
  font-size:13px;
  color:var(--muted);
  user-select:none;
  transition:.2s;
}
.tab.active{
  background: linear-gradient(135deg, rgba(34,197,94,.15), rgba(14,165,233,.15));
  color: var(--text);
  box-shadow: inset 0 0 0 1px rgba(15,23,42,.06);
}

/* form blocks */
.block{
  margin-top:14px;
  padding:12px;
  border:1px solid rgba(15,23,42,.08);
  border-radius:14px;
  background: rgba(255,255,255,.85);
}
label{
  display:block;
  font-size:12px;
  font-weight:800;
  color:var(--muted);
  margin:0 0 6px;
  letter-spacing:.4px;
}
input{
  width:100%;
  padding:12px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:14px;
  outline:none;
  transition:.15s;
}
input:focus{
  border-color: rgba(14,165,233,.55);
  box-shadow:0 0 0 4px rgba(14,165,233,.15);
}
.hint{
  margin-top:8px;
  font-size:12px;
  color:var(--muted);
}

/* buttons */
.btns{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
button{
  flex:1;
  padding:11px 12px;
  border:none;
  border-radius:12px;
  color:#fff;
  cursor:pointer;
  font-weight:900;
  letter-spacing:.2px;
  transition:.15s;
}
button:hover{transform: translateY(-1px)}
button:active{transform:none}
button.primary{background: linear-gradient(135deg, #0ea5e9, #22c55e)}
button.gray{background:#64748b}
button.secondary{background: #16a34a}

/* right panel results */
.main{
  padding:16px 16px 18px;
}
.title{
  font-weight:900;
  font-size:14px;
  color:var(--muted);
  letter-spacing:.35px;
  margin:2px 0 10px;
}
.result{
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(15,23,42,.08);
  background: rgba(255,255,255,.85);
  max-height: 440px;
  overflow:auto;
}
.endereco{
  padding:12px;
  border-radius:14px;
  background:#fff;
  border:1px solid rgba(15,23,42,.08);
}
.endereco + .endereco{margin-top:10px}
.divider{border:0;border-top:1px dashed rgba(15,23,42,.18); margin:12px 0}
.label-bold{font-weight:900}
.small-actions{
  display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
}
.small-actions button{padding:10px}
.notice{
  padding:10px;
  border-radius:14px;
  border:1px solid rgba(245,158,11,.35);
  background: rgba(245,158,11,.15);
  color:#7c2d12;
  font-weight:800;
  margin-bottom:10px;
}
.loading{
  padding:10px;
  border-radius:14px;
  background: rgba(14,165,233,.12);
  border:1px solid rgba(14,165,233,.25);
  color:#0f172a;
  font-weight:900;
}

/* responsive */
@media (max-width: 820px){
  .body{grid-template-columns:1fr}
  .sidebar{border-right:none;border-bottom:1px solid rgba(15,23,42,.08)}
  .result{max-height: 360px}
}
</style>
</head>

<body>
<div class="form-container">
  <div class="header">
    <h2>BUSCA DE ENDEREÇO (CEP / RUA)</h2>
    <div class="badge"><span class="dot"></span> VIA CEP • PB</div>
  </div>

  <div class="body">
    <!-- LEFT -->
    <div class="sidebar">
      <div class="tabs">
        <div class="tab active" onclick="showTab('cep')">CEP</div>
        <div class="tab" onclick="showTab('logradouro')">RUA</div>
      </div>

      <!-- CEP -->
      <div id="cep" class="tab-content active">
        <div class="block">
          <label for="cepInput">CEP</label>
          <input id="cepInput" placeholder="00000-000" onfocus="this.select()">
          <div class="hint">Digite 8 números. O sistema formata automaticamente.</div>

          <div class="btns">
            <button class="primary" onclick="buscarCep()">BUSCAR</button>
            <button class="gray" onclick="limpar()">LIMPAR</button>
          </div>
        </div>
      </div>

      <!-- LOGRADOURO -->
      <div id="logradouro" class="tab-content">
        <div class="block">
          <label for="cidadeInput">CIDADE</label>
          <input id="cidadeInput" value="João Pessoa" placeholder="Cidade" onfocus="this.select()">

          <label for="logradouroInput" style="margin-top:10px">RUA / LOGRADOURO</label>
          <input id="logradouroInput" placeholder="Ex.: Epitácio Pessoa" onfocus="this.select()">

          <div class="hint">Pode digitar só parte do nome. Sem CEP também funciona.</div>

          <div class="btns">
            <button class="primary" onclick="buscarLogradouro()">BUSCAR</button>
            <button class="gray" onclick="limpar()">LIMPAR</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="main">
      <div class="title">RESULTADOS</div>
      <div id="cepResult" class="result" role="alert"></div>
      <div id="logradouroResult" class="result" role="alert" style="display:none"></div>
    </div>
  </div>
</div>

<script>
const UF = 'PB';

/* ==========================
   UTILITÁRIOS (robustos)
========================== */

async function fetchJson(url, timeoutMs = 8000, retries = 1){
  for(let attempt = 0; attempt <= retries; attempt++){
    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort(), timeoutMs);

    try{
      const r = await fetch(url, { signal: controller.signal });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }catch(e){
      if(attempt === retries) throw e;
      await new Promise(res => setTimeout(res, 350));
    }finally{
      clearTimeout(timer);
    }
  }
}

function escapeHtml(str=''){
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function formatCep(c){ return c.replace(/^(\d{5})(\d{3})$/,'$1-$2'); }

function removerAcentos(s=''){
  return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}

function normalizarLogradouro(s=''){
  s = s.trim().replace(/\s+/g,' ');
  s = s.replace(/\./g,'');
  s = s.replace(/^(Rua|R|Avenida|Av|Travessa|Trav|Alameda|Al|Praça|Pç)\s+/i,'');
  return removerAcentos(s);
}

/* ==========================
   Tabs
========================== */

function showTab(id){
  document.querySelectorAll('.tab,.tab-content').forEach(e=>e.classList.remove('active'));
  document.querySelector(`[onclick="showTab('${id}')"]`).classList.add('active');
  document.getElementById(id).classList.add('active');

  // alterna painel de resultados
  const cepR = document.getElementById('cepResult');
  const logR = document.getElementById('logradouroResult');
  if(id === 'cep'){ cepR.style.display = ''; logR.style.display = 'none'; }
  else{ cepR.style.display = 'none'; logR.style.display = ''; }
}

/* ==========================
   LOGRADOURO / BAIRRO
========================== */

function detectarTipoLogradouro(logradouro){
  const tipos = {
    'AVENIDA': /^(Avenida|Av\.?)\s*/i,
    'TRAVESSA': /^(Travessa|Trav\.?)\s*/i,
    'COMUNIDADE': /^(Comunidade)\s*/i,
    'PRAÇA': /^(Praça|Pç\.?)\s*/i,
    'RUA': /^(Rua|R\.?)\s*/i
  };

  for(const [tipo, regex] of Object.entries(tipos)){
    if(regex.test(logradouro)){
      return { tipo, nome: logradouro.replace(regex, '').trim() };
    }
  }

  const matchEspecial = logradouro.match(/^(Sítio|Sitio|Assentamento|Engenho)\s+(.*)/i);
  if(matchEspecial){
    return { tipo: matchEspecial[1].toUpperCase(), nome: matchEspecial[2].trim() };
  }

  return { tipo: 'RUA', nome: logradouro.trim() };
}

function ajustarBairro(bairroApi, logradouro){
  if(bairroApi && bairroApi.trim()) return bairroApi;
  if(/^(Sítio|Sitio|Assentamento|Engenho)/i.test(logradouro)){
    return 'ZONA RURAL';
  }
  return 'CENTRO';
}

/* ==========================
   FORMATO EXATO PARA CÓPIA
   - sequência fixa
   - MAIÚSCULAS
   - Arial Narrow 9,5
========================== */

function buildTextoCopia({tipo, nome, bairro, cidade, cep}){
  // sequência definida por você (ajuste se quiser outra ordem)
  const linhas = [
    `${tipo}: ${nome}`,
    `BAIRRO: ${bairro}`,
    `CIDADE: ${cidade}`,
    `CEP: ${cep}`
  ];
  return linhas.join('\n').toUpperCase();
}

function buildHtmlCopia(textoMaiusculo){
  // HTML rico p/ colar com fonte Arial Narrow e tamanho 9,5
  const textoHtml = escapeHtml(textoMaiusculo).replaceAll('\n','<br>');
  return `
    <div style="font-family:'Arial Narrow', Arial, sans-serif; font-size:9.5pt; line-height:1.25; letter-spacing:.2px; text-transform:uppercase;">
      ${textoHtml}
    </div>
  `;
}

// copia com formatação (HTML + texto)
async function copiarFormatado(textoMaiusculo){
  try{
    if(navigator.clipboard && navigator.clipboard.write){
      const html = buildHtmlCopia(textoMaiusculo);
      const item = new ClipboardItem({
        "text/plain": new Blob([textoMaiusculo], { type: "text/plain" }),
        "text/html": new Blob([html], { type: "text/html" })
      });
      await navigator.clipboard.write([item]);
      return true;
    }
  }catch(e){}
  // fallback texto puro
  try{
    await navigator.clipboard.writeText(textoMaiusculo);
    return true;
  }catch(e){}
  return false;
}

/* ==========================
   RENDER ENDEREÇO
========================== */

function buildEndereco({logradouroOriginal,bairro,cidade,cep, aviso='' }){
  logradouroOriginal = (logradouroOriginal && logradouroOriginal.trim())
    ? logradouroOriginal.trim()
    : 'LOGRADOURO NÃO INFORMADO';

  const {tipo, nome} = detectarTipoLogradouro(logradouroOriginal);

  // manter visual normal, mas tudo em maiúsculas na cópia
  const nomeV = escapeHtml(nome);
  const bairroV = escapeHtml(bairro);
  const cidadeV = escapeHtml(cidade);
  const cepV = escapeHtml(cep);

  const textoCopia = buildTextoCopia({
    tipo, nome,
    bairro, cidade, cep
  });

  return `
    <div class="endereco">
      ${aviso ? `<div class="notice">${aviso}</div>` : ''}

      <div><span class="label-bold">${tipo}:</span> ${nomeV}</div>
      <div><span class="label-bold">BAIRRO:</span> ${bairroV}</div>
      <div><span class="label-bold">CIDADE:</span> ${cidadeV}</div>
      <div><span class="label-bold">CEP:</span> ${cepV}</div>

      <div class="small-actions">
        <button class="secondary" onclick="copiarEnderecoFormatado(\`${textoCopia}\`)">COPIAR ENDEREÇO</button>
        <button class="primary" onclick="copiarEnderecoFormatado(\`${String(cep).toUpperCase()}\`)">COPIAR CEP</button>
      </div>
    </div>
  `;
}

async function copiarEnderecoFormatado(texto){
  const ok = await copiarFormatado(texto);
  const campo = document.querySelector('.tab-content.active input:last-of-type');
  if(campo){ campo.focus(); campo.select(); }
}

/* ==========================
   MÁSCARA CEP + AUTO BUSCA
========================== */

cepInput.setAttribute('inputmode','numeric');
cepInput.setAttribute('maxlength','9');
cepInput.setAttribute('autocomplete','postal-code');

cepInput.addEventListener('input', ()=>{
  let v = cepInput.value.replace(/\D/g,'').slice(0,8);
  if(v.length > 5) v = v.slice(0,5) + '-' + v.slice(5);
  cepInput.value = v;

  const c = v.replace(/\D/g,'');
  if(c.length === 8) buscarCep(); // auto
});

cepInput.addEventListener('paste', ()=>{
  setTimeout(()=>{
    let v = cepInput.value.replace(/\D/g,'').slice(0,8);
    if(v.length > 5) v = v.slice(0,5) + '-' + v.slice(5);
    cepInput.value = v;
  },0);
});

/* ==========================
   BUSCA CEP
========================== */

async function buscarCep(){
  const c = cepInput.value.replace(/\D/g,'');

  if(c.length !== 8){
    document.getElementById('cepResult').innerHTML = 'CEP INVÁLIDO (DIGITE 8 NÚMEROS).';
    return;
  }

  const cepResult = document.getElementById('cepResult');
  cepResult.innerHTML = '<div class="loading">BUSCANDO CEP...</div>';

  try{
    const d = await fetchJson(`https://viacep.com.br/ws/${c}/json/`, 8000, 1);

    if(d.erro){
      cepResult.innerHTML = 'CEP NÃO ENCONTRADO.';
      return;
    }

    const logradouroSeguro = (d.logradouro && d.logradouro.trim())
      ? d.logradouro.trim()
      : 'LOGRADOURO NÃO INFORMADO';

    // não limita: apenas avisa
    let aviso = '';
    if(d.uf !== UF){
      aviso = `⚠️ CEP ENCONTRADO ✅ MAS É DO ESTADO <b>${escapeHtml(d.uf)}</b> (FORA DE ${UF}).`;
    }

    cepResult.innerHTML = buildEndereco({
      logradouroOriginal: logradouroSeguro,
      bairro: ajustarBairro((d.bairro||'').toUpperCase(), logradouroSeguro),
      cidade: `${(d.localidade||'').toUpperCase()}/${(d.uf||'').toUpperCase()}`,
      cep: formatCep(c),
      aviso
    });

    cepInput.focus();
    cepInput.select();
  }catch(e){
    cepResult.innerHTML = 'ERRO AO CONSULTAR VIA CEP. VERIFIQUE A INTERNET E TENTE NOVAMENTE.';
  }
}

/* ==========================
   BUSCA LOGRADOURO
========================== */

async function buscarLogradouro(){
  const cidadeRaw = (cidadeInput.value || '').trim();
  const logRaw = (logradouroInput.value || '').trim();

  const logradouroResult = document.getElementById('logradouroResult');

  if(!cidadeRaw || !logRaw){
    logradouroResult.innerHTML = 'DIGITE A CIDADE E O LOGRADOURO.';
    return;
  }

  logradouroResult.innerHTML = '<div class="loading">BUSCANDO LOGRADOURO...</div>';

  try{
    const tentativas = [
      logRaw,
      `Rua ${logRaw}`,
      `Avenida ${logRaw}`,
      `Travessa ${logRaw}`,
      normalizarLogradouro(logRaw)
    ];

    let achou = [];

    for(const t of tentativas){
      const cidade = encodeURIComponent(cidadeRaw);
      const log = encodeURIComponent(t);

      const d = await fetchJson(`https://viacep.com.br/ws/${UF}/${cidade}/${log}/json/`, 8000, 1);

      if(Array.isArray(d) && d.length){
        achou = d;
        break;
      }
    }

    if(!Array.isArray(achou) || !achou.length){
      logradouroResult.innerHTML = 'NENHUM RESULTADO ENCONTRADO.';
      return;
    }

    // ordena: bairro preenchido primeiro
    achou.sort((a,b)=>{
      const ab = (a.bairro||'').trim().length;
      const bb = (b.bairro||'').trim().length;
      return bb - ab;
    });

    // limita p/ não travar
    const lista = achou.slice(0, 30);

    logradouroResult.innerHTML = lista.map(i=>{
      const bruto = (i.logradouro && i.logradouro.trim()) ? i.logradouro.trim() : logRaw;

      return buildEndereco({
        logradouroOriginal: bruto,
        bairro: ajustarBairro((i.bairro||'').toUpperCase(), bruto),
        cidade: `${(i.localidade||'').toUpperCase()}/${(i.uf||'').toUpperCase()}`,
        cep: (i.cep || '58000-000').toUpperCase()
      });
    }).join('<div class="divider"></div>');

    logradouroInput.focus();
    logradouroInput.select();
  }catch(e){
    logradouroResult.innerHTML = 'ERRO AO CONSULTAR VIA CEP. VERIFIQUE A INTERNET.';
  }
}

/* ==========================
   LIMPAR
========================== */

function limpar(){
  cepInput.value='';
  logradouroInput.value='';
  document.getElementById('cepResult').innerHTML='';
  document.getElementById('logradouroResult').innerHTML='';
  document.querySelector('.form-container').scrollIntoView({behavior:'smooth'});

  const campo = document.querySelector('.tab-content.active input:last-of-type');
  if(campo){ campo.focus(); campo.select(); }
}

// Enter para buscar (tab atual)
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    const tab = document.querySelector('.tab-content.active')?.id;
    if(tab === 'cep') buscarCep();
    if(tab === 'logradouro') buscarLogradouro();
  }
});
</script>
</body>
</html>
