<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="icon" href="img/favicon.ico" type="image/x-icon">
<link rel="icon" href="img/favicon.png" type="image/png">
<meta charset="UTF-8">
<title>Busca por CEP - PB</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%}

:root{
  --bg1:#0ea5e9;
  --bg2:#22c55e;

  --text:#0f172a;
  --muted:#64748b;
  --border:rgba(15,23,42,.10);

  --shadow:0 20px 55px rgba(0,0,0,.25);
  --radius:26px;
}

body{
  font-family: Arial, Helvetica, sans-serif;
  background:
    radial-gradient(1100px 650px at 18% 12%, rgba(255,255,255,.26), transparent 62%),
    linear-gradient(135deg, var(--bg2), var(--bg1));
  display:flex;
  justify-content:center;
  align-items:center;
  padding:18px;
  color:var(--text);
}

/* ==== JANELINHA ==== */
.form-container{
  width: 1000px;
  height: 620px;
  max-width: 96vw;
  max-height: 92vh;

  border-radius: var(--radius);
  overflow: hidden;

  /* glass effect */
  background: rgba(255,255,255,.18);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);

  border: 1px solid rgba(255,255,255,.35);
  box-shadow: var(--shadow);
}

/* header */
.header{
  padding:18px 18px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  background: rgba(255,255,255,.32);
  border-bottom: 1px solid rgba(255,255,255,.30);
}
.header h2{
  margin:0;
  font-size:22px;
  letter-spacing:.8px;
  font-weight:900;
}
.badge{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  font-weight:900;
  color:rgba(15,23,42,.78);
}
.dot{
  width:10px;height:10px;border-radius:999px;
  background:#22c55e;
  box-shadow:0 0 0 4px rgba(34,197,94,.18);
}

/* body layout */
.body{
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:0;
  height: calc(620px - 62px); /* ajusta conforme header */
  max-height: calc(92vh - 62px);
}

/* left panel */
.sidebar{
  padding:16px;
  border-right:1px solid rgba(255,255,255,.30);
  background: rgba(255,255,255,.16);
}

/* tabs */
.tabs{
  display:flex;
  gap:8px;
  background: rgba(255,255,255,.55);
  border:1px solid rgba(255,255,255,.45);
  border-radius:18px;
  padding:6px;
}
.tab{
  flex:1;
  padding:12px 10px;
  text-align:center;
  cursor:pointer;
  border-radius:14px;
  font-weight:900;
  font-size:14px;
  color:rgba(15,23,42,.65);
  user-select:none;
  transition:.2s;
}
.tab.active{
  background: rgba(255,255,255,.65);
  color: var(--text);
  box-shadow: inset 0 0 0 1px rgba(15,23,42,.06);
}

/* form blocks */
.tab-content{display:none}
.tab-content.active{display:block}

.block{
  margin-top:14px;
  padding:14px;
  border:1px solid rgba(255,255,255,.45);
  border-radius:18px;
  background: rgba(255,255,255,.68);
}
label{
  display:block;
  font-size:12px;
  font-weight:900;
  color:rgba(15,23,42,.70);
  margin:0 0 8px;
  letter-spacing:.5px;
}
input{
  width:100%;
  padding:14px 14px;
  border-radius:16px;
  border:1px solid rgba(15,23,42,.12);
  font-size:15px;
  outline:none;
  transition:.15s;
  background: rgba(255,255,255,.86);
}
input:focus{
  border-color: rgba(14,165,233,.60);
  box-shadow:0 0 0 4px rgba(14,165,233,.16);
}

.hint{
  margin-top:10px;
  font-size:13px;
  color:rgba(15,23,42,.68);
}

.btns{
  display:flex;
  gap:12px;
  margin-top:14px;
  flex-wrap:wrap;
}
button{
  flex:1;
  padding:12px 14px;
  border:none;
  border-radius:16px;
  color:#fff;
  cursor:pointer;
  font-weight:900;
  letter-spacing:.2px;
  transition:.15s;
}
button:hover{transform: translateY(-1px)}
button:active{transform:none}
button.primary{background: linear-gradient(135deg, #0ea5e9, #22c55e)}
button.gray{background:#64748b}
button.secondary{background:#16a34a}

/* right panel results */
.main{
  padding:18px;
  background: rgba(255,255,255,.08);
}
.title{
  font-weight:900;
  font-size:15px;
  color:rgba(15,23,42,.70);
  letter-spacing:.45px;
  margin:2px 0 10px;
}
.result{
  padding:14px;
  border-radius:20px;
  border:1px solid rgba(255,255,255,.30);
  background: rgba(255,255,255,.38);
  height: calc(100% - 32px);
  overflow:auto;
}

/* cards endereço */
.endereco{
  padding:14px;
  border-radius:18px;
  background: rgba(255,255,255,.85);
  border:1px solid rgba(15,23,42,.08);
}
.divider{
  height:1px;
  border:0;
  border-top:1px dashed rgba(15,23,42,.22);
  margin:12px 0;
}
.label-bold{font-weight:900}
.small-actions{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:12px;
}
.small-actions button{padding:12px 12px}

.notice{
  padding:12px;
  border-radius:18px;
  border:1px solid rgba(245,158,11,.36);
  background: rgba(245,158,11,.16);
  color:#7c2d12;
  font-weight:900;
  margin-bottom:12px;
}
.loading{
  padding:12px;
  border-radius:18px;
  background: rgba(14,165,233,.16);
  border:1px solid rgba(14,165,233,.28);
  color:rgba(15,23,42,.95);
  font-weight:900;
}

@media (max-width: 860px){
  .form-container{height:auto}
  .body{grid-template-columns:1fr; height:auto}
  .sidebar{border-right:none;border-bottom:1px solid rgba(255,255,255,.30)}
  .result{height:360px}
}
</style>
</head>

<body>
<div class="form-container">
  <div class="header">
    <h2>BUSCA DE ENDEREÇO (CEP / RUA)</h2>
    <div class="badge"><span class="dot"></span> VIA CEP • PB</div>
  </div>

  <div class="body">
    <!-- LEFT -->
    <div class="sidebar">
      <div class="tabs">
        <div id="tabCep" class="tab active" onclick="showTab('cep')">CEP</div>
        <div id="tabRua" class="tab" onclick="showTab('logradouro')">RUA</div>
      </div>

      <!-- CEP -->
      <div id="cep" class="tab-content active">
        <div class="block">
          <label for="cepInput">CEP</label>
          <input id="cepInput" placeholder="00000-000" onfocus="this.select()">
          <div class="hint">Digite 8 números. O sistema formata automaticamente.</div>

          <div class="btns">
            <button class="primary" onclick="buscarCep()">BUSCAR</button>
            <button class="gray" onclick="limpar()">LIMPAR</button>
          </div>
        </div>
      </div>

      <!-- LOGRADOURO -->
      <div id="logradouro" class="tab-content">
        <div class="block">
          <label for="cidadeInput">CIDADE</label>
          <input id="cidadeInput" value="João Pessoa" placeholder="Cidade" onfocus="this.select()">

          <label for="logradouroInput" style="margin-top:12px">RUA / LOGRADOURO</label>
          <input id="logradouroInput" placeholder="Ex.: Elias Cavalcante" onfocus="this.select()">

          <div class="hint">Pode digitar só parte do nome. Se CEP estiver ilegível, pesquise pela rua.</div>

          <div class="btns">
            <button class="primary" onclick="buscarLogradouro()">BUSCAR</button>
            <button class="gray" onclick="limpar()">LIMPAR</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="main">
      <div class="title">RESULTADOS</div>
      <div id="cepResult" class="result" role="alert"></div>
      <div id="logradouroResult" class="result" role="alert" style="display:none"></div>
    </div>
  </div>
</div>

<script>
const UF = 'PB';

/* =========================================================
   CEP GERAL (fallback por município)
========================================================= */
const CEP_GERAL_MUNICIPIO = {
  "JOAO PESSOA": "58000-000",
  "SANTA RITA": "58300-000",
  "BAYEUX": "58305-000",
  "CABEDELO": "58100-000",
  "CAMPINA GRANDE": "58400-000"
};

function removerAcentos(s=''){
  return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}

function chaveCidade(s=''){
  return removerAcentos(s).trim().toUpperCase();
}

function cepGeralDaCidade(nomeCidade){
  const chave = chaveCidade(nomeCidade);
  return CEP_GERAL_MUNICIPIO[chave] || "58000-000";
}

function resolverCep(i){
  if(i?.cep && String(i.cep).trim()) return String(i.cep).toUpperCase();
  return cepGeralDaCidade(i?.localidade || '');
}

/* =========================================================
   UTILITÁRIOS ROBUSTOS
========================================================= */
async function fetchJson(url, timeoutMs = 8000, retries = 1){
  for(let attempt=0; attempt<=retries; attempt++){
    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort(), timeoutMs);

    try{
      const r = await fetch(url, { signal: controller.signal });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }catch(e){
      if(attempt === retries) throw e;
      await new Promise(res => setTimeout(res, 350));
    }finally{
      clearTimeout(timer);
    }
  }
}

function escapeHtml(str=''){
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function formatCep(c){ return c.replace(/^(\d{5})(\d{3})$/,'$1-$2'); }

function normalizarLogradouro(s=''){
  s = (s || '').trim().replace(/\s+/g,' ');
  s = s.replace(/\./g,'');
  s = s.replace(/^(Rua|R|Avenida|Av|Travessa|Trav|Alameda|Al|Praça|Pç)\s+/i,'');
  return removerAcentos(s);
}

/* =========================================================
   TABS
========================================================= */
function showTab(id){
  document.querySelectorAll('.tab,.tab-content').forEach(e=>e.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  if(id === 'cep'){
    tabCep.classList.add('active');
    tabRua.classList.remove('active');
    cepResult.style.display = '';
    logradouroResult.style.display = 'none';
    cepInput.focus();
    cepInput.select();
  }else{
    tabRua.classList.add('active');
    tabCep.classList.remove('active');
    cepResult.style.display = 'none';
    logradouroResult.style.display = '';
    logradouroInput.focus();
    logradouroInput.select();
  }
}

/* =========================================================
   ENDEREÇO
========================================================= */
function detectarTipoLogradouro(logradouro){
  const tipos = {
    'AVENIDA': /^(Avenida|Av\.?)\s*/i,
    'TRAVESSA': /^(Travessa|Trav\.?)\s*/i,
    'COMUNIDADE': /^(Comunidade)\s*/i,
    'PRAÇA': /^(Praça|Pç\.?)\s*/i,
    'RUA': /^(Rua|R\.?)\s*/i
  };

  for(const [tipo, regex] of Object.entries(tipos)){
    if(regex.test(logradouro)){
      return { tipo, nome: logradouro.replace(regex, '').trim() };
    }
  }

  const matchEspecial = logradouro.match(/^(Sítio|Sitio|Assentamento|Engenho)\s+(.*)/i);
  if(matchEspecial){
    return { tipo: matchEspecial[1].toUpperCase(), nome: matchEspecial[2].trim() };
  }

  return { tipo:'RUA', nome: (logradouro || '').trim() };
}

function ajustarBairro(bairroApi, logradouro){
  if(bairroApi && bairroApi.trim()) return bairroApi;
  if(/^(Sítio|Sitio|Assentamento|Engenho)/i.test(logradouro)) return 'ZONA RURAL';
  return 'CENTRO';
}

/* =========================================================
   CÓPIA EXATA (Arial Narrow 9,5 + maiúsculas)
========================================================= */
function buildTextoCopia({tipo, nome, bairro, cidade, cep}){
  const linhas = [
    `${tipo}: ${nome}`,
    `BAIRRO: ${bairro}`,
    `CIDADE: ${cidade}`,
    `CEP: ${cep}`
  ];
  return linhas.join('\n').toUpperCase();
}

function buildHtmlCopia(textoMaiusculo){
  const textoHtml = escapeHtml(textoMaiusculo).replaceAll('\n','<br>');
  return `
    <div style="font-family:'Arial Narrow', Arial, sans-serif; font-size:9.5pt; line-height:1.25; text-transform:uppercase;">
      ${textoHtml}
    </div>
  `;
}

async function copiarFormatado(textoMaiusculo){
  try{
    if(navigator.clipboard && navigator.clipboard.write){
      const html = buildHtmlCopia(textoMaiusculo);
      const item = new ClipboardItem({
        "text/plain": new Blob([textoMaiusculo], { type: "text/plain" }),
        "text/html": new Blob([html], { type: "text/html" })
      });
      await navigator.clipboard.write([item]);
      return true;
    }
  }catch(e){}
  try{
    await navigator.clipboard.writeText(textoMaiusculo);
    return true;
  }catch(e){}
  return false;
}

async function copiarEnderecoFormatado(texto){
  await copiarFormatado(texto);
  const campo = document.querySelector('.tab-content.active input:last-of-type');
  if(campo){ campo.focus(); campo.select(); }
}

/* =========================================================
   RENDER CARD
========================================================= */
function buildEndereco({logradouroOriginal,bairro,cidade,cep, aviso='' }){
  logradouroOriginal = (logradouroOriginal && logradouroOriginal.trim())
    ? logradouroOriginal.trim()
    : 'LOGRADOURO NÃO INFORMADO';

  const {tipo, nome} = detectarTipoLogradouro(logradouroOriginal);

  const textoCopia = buildTextoCopia({
    tipo,
    nome,
    bairro,
    cidade,
    cep
  });

  return `
    <div class="endereco">
      ${aviso ? `<div class="notice">${aviso}</div>` : ''}

      <div><span class="label-bold">${escapeHtml(tipo)}:</span> ${escapeHtml(nome)}</div>
      <div><span class="label-bold">BAIRRO:</span> ${escapeHtml(bairro)}</div>
      <div><span class="label-bold">CIDADE:</span> ${escapeHtml(cidade)}</div>
      <div><span class="label-bold">CEP:</span> ${escapeHtml(cep)}</div>

      <div class="small-actions">
        <button class="secondary" onclick="copiarEnderecoFormatado(\`${textoCopia}\`)">COPIAR ENDEREÇO</button>
        <button class="primary" onclick="copiarEnderecoFormatado(\`${String(cep).toUpperCase()}\`)">COPIAR CEP</button>
      </div>
    </div>
  `;
}

/* =========================================================
   MÁSCARA CEP
========================================================= */
cepInput.setAttribute('inputmode','numeric');
cepInput.setAttribute('maxlength','9');
cepInput.setAttribute('autocomplete','postal-code');

cepInput.addEventListener('input', ()=>{
  let v = cepInput.value.replace(/\D/g,'').slice(0,8);
  if(v.length > 5) v = v.slice(0,5) + '-' + v.slice(5);
  cepInput.value = v;

  const c = v.replace(/\D/g,'');
  if(c.length === 8) buscarCep(); // auto
});

cepInput.addEventListener('paste', ()=>{
  setTimeout(()=>{
    let v = cepInput.value.replace(/\D/g,'').slice(0,8);
    if(v.length > 5) v = v.slice(0,5) + '-' + v.slice(5);
    cepInput.value = v;
  },0);
});

/* =========================================================
   BUSCA CEP
========================================================= */
async function buscarCep(){
  const c = cepInput.value.replace(/\D/g,'');

  if(c.length !== 8){
    cepResult.innerHTML = 'CEP INVÁLIDO (DIGITE 8 NÚMEROS).';
    return;
  }

  cepResult.innerHTML = '<div class="loading">BUSCANDO CEP...</div>';

  try{
    const d = await fetchJson(`https://viacep.com.br/ws/${c}/json/`, 8000, 1);

    if(d.erro){
      cepResult.innerHTML = 'CEP NÃO ENCONTRADO.';
      return;
    }

    const logradouroSeguro = (d.logradouro && d.logradouro.trim())
      ? d.logradouro.trim()
      : 'LOGRADOURO NÃO INFORMADO';

    let aviso = '';
    if(d.uf && d.uf.toUpperCase() !== UF){
      aviso = `⚠️ CEP ENCONTRADO ✅ MAS É DO ESTADO <b>${escapeHtml(d.uf.toUpperCase())}</b> (FORA DE ${UF}).`;
    }

    cepResult.innerHTML = buildEndereco({
      logradouroOriginal: logradouroSeguro,
      bairro: ajustarBairro((d.bairro||'').toUpperCase(), logradouroSeguro),
      cidade: `${(d.localidade||'').toUpperCase()}/${(d.uf||'').toUpperCase()}`,
      cep: formatCep(c),
      aviso
    });

    cepInput.focus();
    cepInput.select();

  }catch(e){
    cepResult.innerHTML = 'ERRO AO CONSULTAR VIA CEP. VERIFIQUE A INTERNET.';
  }
}

/* =========================================================
   BUSCA LOGRADOURO (robusta)
========================================================= */
async function buscarLogradouro(){
  let cidadeRaw = (cidadeInput.value || '').trim();
  let logRaw = (logradouroInput.value || '').trim();

  if(!logRaw){
    logradouroResult.innerHTML = 'DIGITE O NOME DA RUA / LOGRADOURO.';
    return;
  }

  // aceita "RUA X, SANTA RITA PB"
  logRaw = logRaw.replace(/\bPB\b/ig,'').trim();

  if(logRaw.includes(',')){
    const partes = logRaw.split(',').map(p=>p.trim()).filter(Boolean);
    if(partes.length >= 2){
      const possivelRua = partes[0];
      const possivelCidade = partes.slice(1).join(' ').trim();
      logRaw = possivelRua;
      if(!cidadeRaw || cidadeRaw.toUpperCase() === 'JOÃO PESSOA') cidadeRaw = possivelCidade;
    }
  }

  logRaw = logRaw.replace(/\s+/g,' ').trim();
  cidadeRaw = cidadeRaw.replace(/\s+/g,' ').trim();

  if(!cidadeRaw){
    logradouroResult.innerHTML = 'INFORME A CIDADE.';
    return;
  }

  logradouroResult.innerHTML = '<div class="loading">BUSCANDO LOGRADOURO...</div>';

  try{
    const tentativas = [
      logRaw,
      `Rua ${logRaw}`,
      `Avenida ${logRaw}`,
      `Travessa ${logRaw}`,
      normalizarLogradouro(logRaw)
    ];

    let achou = [];

    for(const t of tentativas){
      const cidade = encodeURIComponent(cidadeRaw);
      const log = encodeURIComponent(t);

      const d = await fetchJson(`https://viacep.com.br/ws/${UF}/${cidade}/${log}/json/`, 8000, 1);

      if(Array.isArray(d) && d.length){
        achou = d;
        break;
      }
    }

    if(!Array.isArray(achou) || !achou.length){
      logradouroResult.innerHTML = 'NENHUM RESULTADO ENCONTRADO.';
      return;
    }

    achou.sort((a,b)=>{
      const ab = (a.bairro||'').trim().length;
      const bb = (b.bairro||'').trim().length;
      return bb - ab;
    });

    const lista = achou.slice(0, 30);

    logradouroResult.innerHTML = lista.map(i=>{
      const bruto = (i.logradouro && i.logradouro.trim()) ? i.logradouro.trim() : logRaw;

      const cidade = `${(i.localidade||'').toUpperCase()}/${(i.uf||'').toUpperCase()}`;

      return buildEndereco({
        logradouroOriginal: bruto,
        bairro: ajustarBairro((i.bairro||'').toUpperCase(), bruto),
        cidade,
        cep: resolverCep(i) // ✅ CEP geral se não vier
      });
    }).join('<hr class="divider">');

    logradouroInput.focus();
    logradouroInput.select();

  }catch(e){
    logradouroResult.innerHTML = 'ERRO AO CONSULTAR VIA CEP. VERIFIQUE A INTERNET.';
  }
}

/* =========================================================
   LIMPAR
========================================================= */
function limpar(){
  cepInput.value='';
  logradouroInput.value='';
  cepResult.innerHTML='';
  logradouroResult.innerHTML='';
  document.querySelector('.form-container').scrollIntoView({behavior:'smooth'});

  const campo = document.querySelector('.tab-content.active input:last-of-type');
  if(campo){
    campo.focus();
    campo.select();
  }
}

/* Enter para buscar no tab atual */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    const tab = document.querySelector('.tab-content.active')?.id;
    if(tab === 'cep') buscarCep();
    if(tab === 'logradouro') buscarLogradouro();
  }
});

/* abre sempre no CEP */
window.addEventListener('load', ()=>{
  showTab('cep');
});
</script>
</body>
</html>
